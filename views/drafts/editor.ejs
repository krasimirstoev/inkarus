<div class="writing-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <button class="sidebar-item active"><%= __('Drafts.TheEditor.sidebar_projects') %></button>
    <button class="sidebar-item" id="toggle-notes"><%= __('Drafts.TheEditor.sidebar_notes') %></button>
    <button class="sidebar-item" id="toggle-characters"><%= __('Drafts.TheEditor.sidebar_characters') %></button>
    <button class="sidebar-item" id="toggle-places"><%= __('Drafts.TheEditor.sidebar_places') %></button>
    <button class="sidebar-item" id="toggle-items"><%= __('Drafts.TheEditor.sidebar_items') %></button>
    <button class="sidebar-item"><%= __('Drafts.TheEditor.sidebar_outline') %></button>
  </aside>

  <!-- Main writing area -->
  <section class="editor-area">
    <div class="d-flex justify-content-between align-items-center mb-3 editor-topbar">
      <h2><%= draft.title %></h2>
      <div class="d-flex align-items-center gap-3 flex-wrap" id="status-bar">
        <small>
          ğŸ’¾ <%= __('Drafts.TheEditor.last_autosave') %>: <span id="last-saved"><%= __('Drafts.TheEditor.last_autosave_time') %></span> |
          ğŸ§  <%= __('Drafts.TheEditor.word_count') %>: <span id="word-count">0</span>
        </small>
        <button id="manual-save" class="btn btn-sm btn-outline-light" type="button">ğŸ’¾ <%= __('Drafts.TheEditor.save_now') %></button>
        <button id="open-revisions" class="btn btn-sm btn-outline-secondary" data-id="<%= draft.id %>" data-title="<%= draft.title %>" type="button">ğŸ•˜ <%= __('Drafts.TheEditor.history') %></button>
        <!-- <button id="open-places" class="btn btn-sm btn-outline-secondary ms-2" type="button">ğŸ—ºï¸ Places</button> -->
        <button id="back-to-dashboard" class="btn btn-sm btn-secondary" type="button">â† <%= __('Drafts.TheEditor.back') %></button>
        <button id="toggle-fullscreen" class="btn btn-sm btn-outline-secondary" type="button">â›¶ <%= __('Drafts.TheEditor.fullscreen') %></button>
        <button id="toggle-reading" class="btn btn-sm btn-outline-secondary" type="button">ğŸ“– <%= __('Drafts.TheEditor.reading_mode') %></button>
        <button id="exit-reading" class="btn btn-sm btn-danger d-none" type="button">âœ• <%= __('Drafts.TheEditor.exit_reading') %></button>
        <button id="exit-fullscreen" class="btn btn-sm btn-danger d-none" type="button">âœ• <%= __('Drafts.TheEditor.exit_fullscreen') %></button>
      </div>
    </div>

    <!-- Quill Editor -->
    <form id="editor-form" data-draft-id="<%= draft.id %>" data-project-id="<%= draft.project_id %>">
      <div id="quill-editor"><%- draft.content %></div>
    </form>

    <!-- Notes Panel -->
    <div id="notes-panel" class="side-panel d-none">
      <div class="panel-header">
        <h5>ğŸ“ <%= __('Drafts.TheEditor.project_notes') %></h5>
        <button id="close-notes" class="btn btn-sm btn-outline-light">âœ•</button>
      </div>
      <div class="panel-body">
        <form id="note-form" class="mb-3" data-project-id="<%= draft.project_id %>">
          <div class="mb-2">
            <label for="note-title" class="form-label"><%= __('Drafts.TheEditor.note_title') %></label>
            <input type="text" id="note-title" class="form-control" required />
          </div>
          <div class="mb-2">
            <label for="note-content" class="form-label"><%= __('Drafts.TheEditor.note_content') %></label>
            <textarea id="note-content" class="form-control" rows="4" required></textarea>
          </div>
          <button type="submit" class="btn btn-sm btn-outline-success">â• <%= __('Drafts.TheEditor.add_note') %></button>
        </form>
        <div id="note-list" class="mt-4">
          <p class="text-muted small"><%= __('Drafts.TheEditor.notes_placeholder') %></p>
        </div>
      </div>
    </div>

    <!-- Characters Panel -->
    <div id="characters-panel" class="side-panel d-none">
      <div class="panel-header">
        <h5>ğŸ§ <%= __('Drafts.TheEditor.characters') %></h5>
        <button id="close-characters" class="btn btn-sm btn-outline-light">âœ•</button>
      </div>
      <div class="panel-body">
        <input type="text" id="character-search" class="form-control mb-3" placeholder="<%= __('Drafts.TheEditor.search_characters') %>" />
        <div id="character-list">
          <p class="text-muted small"><%= __('Drafts.TheEditor.characters_placeholder') %></p>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Character Modal -->
<div class="modal fade" id="characterModal" tabindex="-1" aria-labelledby="characterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="characterModalLabel"><%= __('Drafts.TheEditor.character_info') %></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="characterModalBody">
        <div class="text-center text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Revisions Modal -->
<div class="modal fade" id="revisionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 id="revisionsModalTitle" class="modal-title">
          <span id="revisionsModalText"><%= __('Drafts.TheEditor.RevisionsModalTitle') %></span>
          <span class="badge bg-secondary ms-2" id="revision-count">0</span>
          <button id="delete-autosaves-btn" class="btn btn-sm btn-outline-danger ms-2" title="<%= __('Drafts.TheEditor.delete_autosaves') %>">ğŸ§¹</button>
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="revisions-list">
        <div class="text-center text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Revision Preview Modal -->
<div class="modal fade" id="revisionPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><%= __('Drafts.TheEditor.RevisionPreviewModalTitle') %></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="revisionPreviewContent">
        <div class="text-muted text-center">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Places Panel -->
<div id="places-panel" class="side-panel d-none">
  <div class="panel-header d-flex justify-content-between align-items-center">
    <h5>ğŸ—ºï¸ <%= __('Drafts.TheEditor.places') %></h5>
    <button id="close-places" class="btn btn-sm btn-outline-light">âœ•</button>
  </div>
  <div class="panel-body p-2">
    <input type="text" id="place-search" class="form-control mb-2" placeholder="<%= __('Drafts.TheEditor.search_places') %>">
    <ul id="place-list" class="list-group list-group-flush"></ul>
  </div>
</div>

<!-- Places modal-->
<div class="modal fade" id="placeModal" tabindex="-1" aria-labelledby="placeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="placeModalLabel"><%= __('Drafts.TheEditor.place_info') %></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="placeModalBody">
          <div class="text-center text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

<!-- Items Panel -->
<div id="items-panel" class="side-panel d-none">
  <div class="panel-header d-flex justify-content-between align-items-center">
    <h5>ğŸ§¿ <%= __('Drafts.TheEditor.items') %></h5>
    <button id="close-items" class="btn btn-sm btn-outline-light">âœ•</button>
  </div>
  <div class="panel-body p-2">
    <input type="text" id="item-search" class="form-control mb-2" placeholder="<%= __('Drafts.TheEditor.search_items') %>">
    <ul id="item-list" class="list-group list-group-flush"></ul>
  </div>
</div>

<!-- Items modal-->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="itemModalLabel"><%= __('Drafts.TheEditor.item_info') %></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="itemModalBody">
        <div class="text-center text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>


<!-- Quill Snow CSS via Skypack -->
<link
  rel="stylesheet"
  href="https://cdn.skypack.dev/quill@1.3.7/dist/quill.snow.css"
/>

<!-- Load Quill as an ES module and expose globally -->
<script type="module">
  import Quill from 'https://cdn.skypack.dev/quill@1.3.7';
  window.Quill = Quill;
</script>

  <!-- Inject translations and helper into browser -->
<script>
  // helper function to support dot notation for translations
  window.__ = function(key) {
    const parts = key.split('.');
    let o = window.translations;
    for (const p of parts) {
      if (!o || typeof o !== 'object' || !(p in o)) {
        return key;   // fallback 
      }
      o = o[p];
    }
    return o;
  };

  // full translations object from server
  window.translations = <%- JSON.stringify(translations || {}) %>;
</script>

<!-- Our application scripts -->
<script type="module" src="/js/quill-init.js"></script>
<script type="module" src="/js/pages/character-panel.js"></script>
<script type="module" src="/js/pages/character-highlighter.js"></script>
<script type="module" src="/js/pages/revision-panel.js"></script>
<script type="module" src="/js/pages/place-panel.js"></script>
<script type="module" src="/js/pages/place-highlighter.js"></script>
<script type="module" src="/js/pages/item-panel.js"></script>


