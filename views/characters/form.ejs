<!-- views/characters/form.ejs --> 
<div class="container py-5">
  <h2><%= character ? __('Characters.Form.edit') : __('Characters.Form.new') %></h2>

  <form action="/characters/<%= projectId %><%= character ? '/' + character.id : '' %>" method="POST" class="mt-4">

    <!-- Basic Info -->
    <div class="mb-3">
      <label for="name" class="form-label">ğŸ§ <%= __('Characters.Form.name') %></label>
      <input type="text" class="form-control" id="name" name="name" value="<%= character?.name || '' %>" required>
    </div>

    <div class="mb-3">
      <label for="pseudonym" class="form-label">ğŸ•µï¸ <%= __('Characters.Form.pseudonym') %></label>
      <input type="text" class="form-control" id="pseudonym" name="pseudonym" value="<%= character?.pseudonym || '' %>">
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">ğŸ“ <%= __('Characters.Form.description') %></label>
      <textarea class="form-control" id="description" name="description" rows="3"><%= character?.description || '' %></textarea>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="birthdate" class="form-label">ğŸ‚ <%= __('Characters.Form.birthdate') %></label>
        <input type="text" class="form-control" name="birthdate" id="birthdate" value="<%= character?.birthdate || '' %>">
      </div>

      <div class="col-md-6 mb-3">
        <label for="gender" class="form-label">âš§ <%= __('Characters.Form.gender') %></label>
        <input type="text" class="form-control" id="gender" name="gender" value="<%= character?.gender || '' %>">
      </div>
    </div>

    <div class="mb-3">
      <label for="origin" class="form-label">ğŸŒ <%= __('Characters.Form.origin') %></label>
      <input type="text" class="form-control" id="origin" name="origin" value="<%= character?.origin || '' %>">
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="occupation" class="form-label">ğŸ’¼ <%= __('Characters.Form.occupation') %></label>
        <input type="text" class="form-control" id="occupation" name="occupation" value="<%= character?.occupation || '' %>">
      </div>

      <div class="col-md-6 mb-3">
        <label for="location" class="form-label">ğŸ“ <%= __('Characters.Form.location') %></label>
        <input type="text" class="form-control" id="location" name="location" value="<%= character?.location || '' %>">
      </div>
    </div>

    <div class="mb-3">
      <label for="health_status" class="form-label">ğŸ©º <%= __('Characters.Form.health_status') %></label>
      <select class="form-select" id="health_status" name="health_status">
        <option value="healthy" <%= character?.health_status === 'healthy' ? 'selected' : '' %>><%= __('Characters.Form.healthy') %></option>
        <option value="sick" <%= character?.health_status === 'sick' ? 'selected' : '' %>><%= __('Characters.Form.sick') %></option>
        <option value="injured" <%= character?.health_status === 'injured' ? 'selected' : '' %>><%= __('Characters.Form.injured') %></option>
        <option value="deceased" <%= character?.health_status === 'deceased' ? 'selected' : '' %>><%= __('Characters.Form.deceased') %></option>
      </select>
    </div>

    <div class="mb-3">
      <label for="comment" class="form-label">ğŸ—’ï¸ <%= __('Characters.Form.comment') %></label>
      <textarea class="form-control" id="comment" name="comment" rows="3"><%= character?.comment || '' %></textarea>
    </div>

    <hr class="my-4">

    <!-- New fields for deeper character profiles -->

    <h4>ğŸ¯ <%= __('Characters.Form.details') %></h4>

    <div class="mb-3">
      <label for="goal" class="form-label">ğŸ¯ <%= __('Characters.Form.goal') %></label>
      <textarea class="form-control" id="goal" name="goal" rows="2"><%= character?.goal || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="character_type" class="form-label">ğŸ“š <%= __('Characters.Form.character_type') %></label>
      <select class="form-select" id="character_type" name="character_type">
        <option value=""><%= __('Characters.Form.select_type') %></option>
        <option value="Protagonist" <%= character?.character_type === 'Protagonist' ? 'selected' : '' %>><%= __('Characters.Form.protagonist') %></option>
        <option value="Antagonist" <%= character?.character_type === 'Antagonist' ? 'selected' : '' %>><%= __('Characters.Form.antagonist') %></option>
        <option value="Supporting" <%= character?.character_type === 'Supporting' ? 'selected' : '' %>><%= __('Characters.Form.supporting') %></option>
        <option value="Mentor" <%= character?.character_type === 'Mentor' ? 'selected' : '' %>><%= __('Characters.Form.mentor') %></option>
        <option value="Other" <%= character?.character_type === 'Other' ? 'selected' : '' %>><%= __('Characters.Form.other') %></option>
      </select>
    </div>

    <div class="mb-3">
      <label for="motivation" class="form-label">ğŸ”¥ <%= __('Characters.Form.motivation') %></label>
      <textarea class="form-control" id="motivation" name="motivation" rows="2"><%= character?.motivation || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="fears" class="form-label">ğŸ˜¨ <%= __('Characters.Form.fears') %></label>
      <textarea class="form-control" id="fears" name="fears" rows="2"><%= character?.fears || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="weaknesses" class="form-label">ğŸ’” <%= __('Characters.Form.weaknesses') %></label>
      <textarea class="form-control" id="weaknesses" name="weaknesses" rows="2"><%= character?.weaknesses || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="arc" class="form-label">ğŸŒ€ <%= __('Characters.Form.arc') %></label>
      <select class="form-select" id="arc" name="arc">
        <option value=""><%= __('Characters.Form.select_arc') %></option>
        <option value="Positive" <%= character?.arc === 'Positive' ? 'selected' : '' %>><%= __('Characters.Form.arc_positive') %></option>
        <option value="Negative" <%= character?.arc === 'Negative' ? 'selected' : '' %>><%= __('Characters.Form.arc_negative') %></option>
        <option value="Flat" <%= character?.arc === 'Flat' ? 'selected' : '' %>><%= __('Characters.Form.arc_flat') %></option>
      </select>
    </div>

    <div class="mb-3">
      <label for="secrets" class="form-label">ğŸ¤« <%= __('Characters.Form.secrets') %></label>
      <textarea class="form-control" id="secrets" name="secrets" rows="2"><%= character?.secrets || '' %></textarea>
    </div>

    <div class="mb-3">
      <label for="allies" class="form-label">ğŸ›¡ï¸ <%= __('Characters.Form.allies') %></label>
      <input type="text" class="form-control" id="allies" name="allies" value="<%= character?.allies || '' %>">
    </div>

    <div class="mb-3">
      <label for="enemies" class="form-label">âš”ï¸ <%= __('Characters.Form.enemies') %></label>
      <input type="text" class="form-control" id="enemies" name="enemies" value="<%= character?.enemies || '' %>">
    </div>

    <hr class="my-4">

    <!-- Optional Relationship -->
    <h5>ğŸ”— <%= __('Characters.Form.optional_relation') %></h5>
    <div class="row">
      <div class="col-md-8 mb-3">
        <label for="related_character_id" class="form-label"><%= __('Characters.Form.choose_related') %></label>
        <select class="form-select" id="related_character_id" name="related_character_id">
          <option value=""><%= __('Characters.Form.none') %></option>
          <% allCharacters.forEach(c => { %>
            <% if (!character || c.id !== character.id) { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% } %>
          <% }) %>
        </select>
      </div>

      <div class="col-md-4 mb-3">
        <label for="relation" class="form-label"><%= __('Characters.Form.relation_type') %></label>
        <input type="text" class="form-control" id="relation" name="relation" placeholder="<%= __('Characters.Form.relation_placeholder') %>">
      </div>
    </div>

    <button type="submit" class="btn btn-success">ğŸ’¾ <%= __('Characters.Form.save') %></button>
    <a href="/characters/<%= projectId %>" class="btn btn-secondary ms-2">â† <%= __('Characters.Form.back') %></a>
  </form>
</div>

<!-- Include select2 for relation -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('related_character_id');
    if (select) $(select).select2({ width: '100%' });
  });
</script>

<!-- Include FlatPickr for calendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  flatpickr("input[name='birthdate']", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "F j, Y",
    allowInput: true
  });
</script>
